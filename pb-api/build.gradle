// --- plugins ---
plugins {
    id 'java'
    id 'fabric-loom'                     // cần cho net.minecraft.*
    id 'com.github.johnrengelman.shadow'
    id 'architectury-plugin'
}

// --- thông tin cơ bản ---
group = 'me.earth.pingbypass'
version = rootProject.hasProperty("version") ? rootProject.version : "1.0.0"

// --- Architectury cấu hình Minecraft ---
architectury {
    // ✅ kiểm tra thuộc tính minecraft_version từ root, nếu không có thì fallback
    minecraft = rootProject.hasProperty("minecraft_version") ? rootProject.minecraft_version : "1.21.1"
}

// --- Repositories ---
repositories {
    mavenCentral()
    maven { url = "https://maven.fabricmc.net/" }
    maven { url = "https://maven.architectury.dev/" }
    maven { url = "https://repo.spongepowered.org/maven" }
}

// --- Dependencies ---
dependencies {
    // ✅ đảm bảo lấy đúng version từ root hoặc fallback
    def mcVersion = rootProject.hasProperty("minecraft_version") ? rootProject.minecraft_version : "1.21.1"

    minecraft "com.mojang:minecraft:${mcVersion}"
    mappings "net.fabricmc:yarn:${mcVersion}+build.3:v2"
    modImplementation "net.fabricmc:fabric-loader:0.16.9"

    compileOnly 'org.eclipse.jdt:ecj:3.34.0'
    compileOnly 'org.jetbrains:annotations:24.0.1'

    compileOnly 'org.projectlombok:lombok:1.18.30'
    annotationProcessor 'org.projectlombok:lombok:1.18.30'

    implementation 'org.ow2.asm:asm:9.7'
    implementation 'org.ow2.asm:asm-tree:9.7'
    implementation 'org.ow2.asm:asm-util:9.7'
    implementation 'org.ow2.asm:asm-analysis:9.7'
    implementation 'org.ow2.asm:asm-commons:9.7'

    compileOnly 'org.spongepowered:mixin:0.8.5-SNAPSHOT'

    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.9.2'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.9.2'
}

// --- Java config ---
java {
    toolchain.languageVersion.set(JavaLanguageVersion.of(21))
    withSourcesJar()
    withJavadocJar()
}

// --- Java compile options ---
tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'
    options.fork = true
    //options.forkOptions.executable = file("${System.getenv('JAVA_HOME') ?: System.properties['java.home']}/bin/javac")
    options.compilerArgs.removeAll { it.startsWith('--release') }
    options.compilerArgs << "-proc:none"

    options.compilerArgs.addAll([
        '--add-opens=jdk.compiler/com.sun.tools.javac.jvm=ALL-UNNAMED',
        '--add-opens=jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED',
        '--add-opens=jdk.compiler/com.sun.tools.javac.code=ALL-UNNAMED',
        '--add-opens=jdk.compiler/com.sun.tools.javac.comp=ALL-UNNAMED',
        '--add-opens=jdk.compiler/com.sun.tools.javac.file=ALL-UNNAMED',
        '--add-opens=jdk.compiler/com.sun.tools.javac.main=ALL-UNNAMED',
        '--add-opens=jdk.compiler/com.sun.tools.javac.model=ALL-UNNAMED',
        '--add-opens=jdk.compiler/com.sun.tools.javac.parser=ALL-UNNAMED',
        '--add-opens=jdk.compiler/com.sun.tools.javac.processing=ALL-UNNAMED',
        '--add-opens=jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED',
        '--add-opens=jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED',
        '--add-opens=java.base/java.lang.reflect=ALL-UNNAMED'
    ])
}

// --- Javadoc ---
javadoc {
    source = sourceSets.main.allJava
    options.addStringOption('Xdoclint:none', '-quiet')
    options.linkSource true
}

// --- Sources Jar ---
tasks.named('sourcesJar') {
    from sourceSets.main.allJava
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
}

// --- Process Fabric Resources ---
tasks.register("processFabricResources", Copy) {
    from("src/main/resources")
    include("fabric.mod.json")
    expand(version: project.version)
    into("$buildDir/resources/main")
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
}

// --- IntelliJ config ---
idea {
    module {
        inheritOutputDirs = false
        outputDir = compileJava.destinationDirectory.getAsFile().getOrNull()
        testOutputDir = compileTestJava.destinationDirectory.getAsFile().getOrNull()
    }
}
